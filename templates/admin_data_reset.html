{% extends "admin_base.html" %}

{% block title %}Data Reset - Caspian Shop{% endblock %}

{% block page_title %}Data Reset & Management{% endblock %}
{% block page_subtitle %}Manage and reset your database data</{% endblock %}

{% block admin_content %}
<!-- Warning Alert -->
<div class="alert alert-danger">
    <div class="alert-icon">
        <i class="bi bi-exclamation-triangle"></i>
    </div>
    <div class="alert-content">
        <h5>‚ö†Ô∏è Warning: Destructive Operations</h5>
        <p>
            <strong>These actions cannot be undone!</strong> 
            Deleting data will permanently remove records from your database. 
            Make sure you have backups if needed.
        </p>
    </div>
</div>

<!-- Data Statistics -->
<div class="dashboard-card">
    <div class="card-header">
        <h5 class="card-title">Current Data Statistics</h5>
        <span class="card-subtitle">What you currently have in your database</span>
    </div>
    <div class="card-body">
        <div class="data-stats-grid">
            <div class="stat-card">
                <div class="stat-icon products">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.products }}</h3>
                    <p>Products</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon sales">
                    <i class="bi bi-cart-check"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.sales }}</h3>
                    <p>Sales Records</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon expenses">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.expenses }}</h3>
                    <p>Expense Records</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon categories">
                    <i class="bi bi-tags"></i>
                </div>
                <div class="stat-info">
                    <h3>{{ stats.categories }}</h3>
                    <p>Expense Categories</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon revenue">
                    <i class="bi bi-currency-exchange"></i>
                </div>
                <div class="stat-info">
                    <h3>KES {{ "%.0f"|format(stats.total_revenue) }}</h3>
                    <p>Total Revenue</p>
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon expense-total">
                    <i class="bi bi-wallet2"></i>
                </div>
                <div class="stat-info">
                    <h3>KES {{ "%.0f"|format(stats.total_expenses) }}</h3>
                    <p>Total Expenses</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Selective Data Deletion -->
<div class="dashboard-card">
    <div class="card-header">
        <h5 class="card-title">Selective Data Deletion</h5>
        <span class="card-subtitle">Delete specific types of data</span>
    </div>
    <div class="card-body">
        <div class="selection-grid">
            <div class="selection-item" data-type="sales">
                <div class="selection-icon">
                    <i class="bi bi-cart-check"></i>
                </div>
                <div class="selection-content">
                    <h6>Sales Data</h6>
                    <p>Delete all sales records and transaction history</p>
                    <span class="data-count">{{ stats.sales }} records</span>
                </div>
                <div class="selection-checkbox">
                    <input type="checkbox" id="salesCheckbox" class="data-checkbox">
                </div>
            </div>
            
            <div class="selection-item" data-type="expenses">
                <div class="selection-icon">
                    <i class="bi bi-cash-coin"></i>
                </div>
                <div class="selection-content">
                    <h6>Expenses Data</h6>
                    <p>Delete all expense records and categories</p>
                    <span class="data-count">{{ stats.expenses }} records, {{ stats.categories }} categories</span>
                </div>
                <div class="selection-checkbox">
                    <input type="checkbox" id="expensesCheckbox" class="data-checkbox">
                </div>
            </div>
            
            <div class="selection-item" data-type="products">
                <div class="selection-icon">
                    <i class="bi bi-box-seam"></i>
                </div>
                <div class="selection-content">
                    <h6>Products Data</h6>
                    <p>Delete all products and their images</p>
                    <span class="data-count">{{ stats.products }} products</span>
                </div>
                <div class="selection-checkbox">
                    <input type="checkbox" id="productsCheckbox" class="data-checkbox">
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button id="deleteSelectedBtn" class="btn btn-warning" disabled>
                <i class="bi bi-trash"></i>
                Delete Selected Data
            </button>
        </div>
    </div>
</div>

<!-- Complete Data Reset -->
<div class="dashboard-card danger-zone">
    <div class="card-header danger-header">
        <h5 class="card-title">
            <i class="bi bi-exclamation-octagon"></i> 
            Complete Data Reset
        </h5>
        <span class="card-subtitle">Delete EVERYTHING (Except user accounts)</span>
    </div>
    <div class="card-body">
        <div class="danger-warning">
            <div class="warning-icon">
                <i class="bi bi-fire"></i>
            </div>
            <div class="warning-content">
                <h6>üö® This will delete ALL your business data!</h6>
                <p>
                    This action will permanently delete:
                    <strong>All products, all sales records, all expenses, all categories.</strong><br>
                    Only user accounts will remain. This cannot be undone!
                </p>
            </div>
        </div>
        
        <div class="confirmation-section">
            <p class="confirmation-text">
                To confirm, please type <code>delete all data</code> in the box below:
            </p>
            <div class="confirmation-input">
                <input type="text" 
                       id="confirmText" 
                       class="form-control" 
                       placeholder="Type 'delete all data' here">
                <div class="input-feedback" id="confirmFeedback"></div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <button id="deleteAllBtn" class="btn btn-danger" disabled>
                <i class="bi bi-bomb"></i>
                DELETE ALL DATA
            </button>
        </div>
    </div>
</div>

<!-- Database Backup Info -->
<div class="dashboard-card">
    <div class="card-header">
        <h5 class="card-title">Database Backup</h5>
        <span class="card-subtitle">Before deleting data, consider backing up</span>
    </div>
    <div class="card-body">
        <div class="backup-info">
            <p>Your database is located at: <code>instance/shop.db</code></p>
            <p>To manually backup your data:</p>
            <ol>
                <li>Stop the Flask application</li>
                <li>Copy the file <code>instance/shop.db</code> to a safe location</li>
                <li>Rename it (e.g., <code>shop_backup_2024.db</code>)</li>
                <li>Restart the application</li>
            </ol>
            <div class="text-center mt-3">
                <a href="/admin/dashboard" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i>
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">
                    <i class="bi bi-exclamation-triangle text-warning"></i>
                    Confirm Deletion
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Dynamic content will go here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* Alert Styling */
.alert {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 20px;
    border-radius: 12px;
    margin-bottom: 24px;
    border: 2px solid;
}

.alert-danger {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border-color: #f87171;
    color: #991b1b;
}

.alert-icon {
    font-size: 24px;
    flex-shrink: 0;
}

.alert-content h5 {
    margin: 0 0 8px 0;
    font-size: 18px;
}

.alert-content p {
    margin: 0;
    line-height: 1.5;
}

/* Data Stats Grid */
.data-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    display: flex;
    align-items: center;
    gap: 16px;
    border: 2px solid #e2e8f0;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
}

.stat-icon {
    width: 56px;
    height: 56px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
}

.stat-icon.products {
    background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
}

.stat-icon.sales {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.stat-icon.expenses {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}

.stat-icon.categories {
    background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
}

.stat-icon.revenue {
    background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
}

.stat-icon.expense-total {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}

.stat-info h3 {
    font-size: 28px;
    font-weight: 800;
    margin: 0 0 4px 0;
    color: #1e293b;
}

.stat-info p {
    font-size: 14px;
    color: #64748b;
    margin: 0;
}

/* Selection Grid */
.selection-grid {
    display: flex;
    flex-direction: column;
    gap: 16px;
}

.selection-item {
    display: flex;
    align-items: center;
    gap: 16px;
    padding: 20px;
    background: #f8fafc;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
    cursor: pointer;
    transition: all 0.2s ease;
}

.selection-item:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

.selection-item.selected {
    background: #fff7ed;
    border-color: #f59e0b;
}

.selection-icon {
    width: 48px;
    height: 48px;
    border-radius: 10px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    flex-shrink: 0;
}

.selection-content {
    flex: 1;
}

.selection-content h6 {
    font-size: 16px;
    font-weight: 600;
    color: #1e293b;
    margin: 0 0 4px 0;
}

.selection-content p {
    font-size: 14px;
    color: #64748b;
    margin: 0 0 8px 0;
    line-height: 1.4;
}

.data-count {
    font-size: 12px;
    color: #94a3b8;
    font-weight: 500;
}

.selection-checkbox {
    flex-shrink: 0;
}

.data-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
}

/* Danger Zone */
.danger-zone {
    border: 3px solid #ef4444;
}

.danger-header {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    border-bottom: 2px solid #ef4444;
}

.danger-header .card-title {
    color: #991b1b;
}

.danger-warning {
    display: flex;
    align-items: flex-start;
    gap: 16px;
    padding: 20px;
    background: #fee2e2;
    border-radius: 12px;
    border: 2px solid #f87171;
    margin-bottom: 24px;
}

.warning-icon {
    width: 48px;
    height: 48px;
    border-radius: 12px;
    background: #ef4444;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    flex-shrink: 0;
}

.warning-content h6 {
    color: #991b1b;
    margin: 0 0 8px 0;
    font-size: 18px;
}

.warning-content p {
    color: #991b1b;
    margin: 0;
    line-height: 1.5;
}

.warning-content strong {
    color: #7f1d1d;
}

/* Confirmation Section */
.confirmation-section {
    padding: 24px;
    background: #f8fafc;
    border-radius: 12px;
    border: 2px solid #e2e8f0;
}

.confirmation-text {
    color: #475569;
    margin-bottom: 16px;
    text-align: center;
}

.confirmation-text code {
    background: #1e293b;
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-weight: bold;
}

.confirmation-input {
    max-width: 400px;
    margin: 0 auto;
}

.input-feedback {
    font-size: 13px;
    margin-top: 6px;
    min-height: 20px;
}

.input-feedback.valid {
    color: #10b981;
}

.input-feedback.invalid {
    color: #ef4444;
}

/* Backup Info */
.backup-info {
    color: #475569;
}

.backup-info p {
    margin-bottom: 12px;
}

.backup-info ol {
    margin-left: 20px;
    margin-bottom: 20px;
}

.backup-info li {
    margin-bottom: 8px;
}

.backup-info code {
    background: #f1f5f9;
    padding: 2px 6px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 12px 24px;
    border-radius: 8px;
    font-weight: 600;
    font-size: 14px;
    text-decoration: none;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-warning {
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
}

.btn-warning:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(245, 158, 11, 0.4);
}

.btn-danger {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    color: white;
}

.btn-danger:hover:not(:disabled) {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
}

.btn-secondary {
    background: white;
    color: #475569;
    border: 2px solid #e2e8f0;
}

.btn-secondary:hover {
    background: #f1f5f9;
    border-color: #cbd5e1;
}

/* Modal */
.modal-content {
    border-radius: 16px;
    border: none;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
}

.modal-header {
    padding: 24px;
    border-bottom: 1px solid #e2e8f0;
}

.modal-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 20px;
    font-weight: 600;
    color: #1e293b;
    margin: 0;
}

.modal-body {
    padding: 24px;
    font-size: 16px;
    color: #475569;
    line-height: 1.5;
}

.modal-footer {
    padding: 20px 24px;
    border-top: 1px solid #e2e8f0;
}

/* Responsive */
@media (max-width: 768px) {
    .data-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .selection-item {
        flex-direction: column;
        align-items: stretch;
        text-align: center;
    }
    
    .selection-checkbox {
        align-self: center;
    }
    
    .danger-warning {
        flex-direction: column;
        text-align: center;
    }
}

@media (max-width: 480px) {
    .data-stats-grid {
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// DOM Elements
const confirmTextInput = document.getElementById('confirmText');
const confirmFeedback = document.getElementById('confirmFeedback');
const deleteAllBtn = document.getElementById('deleteAllBtn');
const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
const dataCheckboxes = document.querySelectorAll('.data-checkbox');
const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
const confirmModalBody = document.getElementById('confirmModalBody');
const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

// Current deletion type
let currentDeleteType = 'all'; // 'all' or 'selected'
let selectedDataTypes = [];

// Check confirmation text for complete reset
confirmTextInput.addEventListener('input', function() {
    const text = this.value.trim().toLowerCase();
    const requiredText = 'delete all data';
    
    if (text === requiredText) {
        confirmFeedback.textContent = '‚úì Confirmation text matches';
        confirmFeedback.className = 'input-feedback valid';
        deleteAllBtn.disabled = false;
    } else if (text) {
        confirmFeedback.textContent = `Type "${requiredText}" exactly`;
        confirmFeedback.className = 'input-feedback invalid';
        deleteAllBtn.disabled = true;
    } else {
        confirmFeedback.textContent = '';
        confirmFeedback.className = 'input-feedback';
        deleteAllBtn.disabled = true;
    }
});

// Handle checkbox selection
dataCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
        const selectionItem = this.closest('.selection-item');
        
        if (this.checked) {
            selectionItem.classList.add('selected');
        } else {
            selectionItem.classList.remove('selected');
        }
        
        // Update selected data types
        selectedDataTypes = Array.from(dataCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.closest('.selection-item').dataset.type);
        
        // Enable/disable delete button
        deleteSelectedBtn.disabled = selectedDataTypes.length === 0;
    });
});

// Delete Selected Data
deleteSelectedBtn.addEventListener('click', function() {
    currentDeleteType = 'selected';
    
    const typeNames = {
        'sales': 'Sales Data',
        'expenses': 'Expenses Data',
        'products': 'Products Data'
    };
    
    const selectedNames = selectedDataTypes.map(type => typeNames[type]).join(', ');
    
    confirmModalBody.innerHTML = `
        <div class="confirmation-alert">
            <div class="alert-icon">
                <i class="bi bi-exclamation-triangle text-warning"></i>
            </div>
            <div class="alert-content">
                <h6>Delete Selected Data?</h6>
                <p>You are about to delete:</p>
                <ul>
                    ${selectedDataTypes.map(type => `<li><strong>${typeNames[type]}</strong></li>`).join('')}
                </ul>
                <p class="text-danger"><strong>This action cannot be undone!</strong></p>
            </div>
        </div>
    `;
    
    confirmModal.show();
});

// Delete All Data
deleteAllBtn.addEventListener('click', function() {
    currentDeleteType = 'all';
    
    confirmModalBody.innerHTML = `
        <div class="confirmation-alert">
            <div class="alert-icon">
                <i class="bi bi-exclamation-triangle text-danger"></i>
            </div>
            <div class="alert-content">
                <h6 class="text-danger">üö® DELETE ALL DATA?</h6>
                <p>You are about to delete <strong>EVERYTHING</strong> from your database:</p>
                <ul>
                    <li>All Products ({{ stats.products }})</li>
                    <li>All Sales Records ({{ stats.sales }})</li>
                    <li>All Expenses ({{ stats.expenses }})</li>
                    <li>All Expense Categories ({{ stats.categories }})</li>
                </ul>
                <p class="text-danger"><strong>THIS ACTION CANNOT BE UNDONE!</strong></p>
                <p>Only user accounts will remain.</p>
            </div>
        </div>
    `;
    
    confirmModal.show();
});

// Confirm Deletion
confirmDeleteBtn.addEventListener('click', function() {
    // Disable button and show loading
    this.innerHTML = '<i class="bi bi-hourglass-split"></i> Deleting...';
    this.disabled = true;
    
    let endpoint, payload;
    
    if (currentDeleteType === 'all') {
        endpoint = '/admin/delete-all-data';
        payload = { confirm_text: 'delete all data' };
    } else {
        endpoint = '/admin/delete-specific-data';
        payload = { data_types: selectedDataTypes };
    }
    
    // Send request
    fetch(endpoint, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            confirmModal.hide();
            
            // Show success message
            alert(`‚úÖ ${data.message}`);
            
            // Refresh page after 2 seconds
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            alert(`‚ùå Error: ${data.error}`);
            confirmModal.hide();
        }
    })
    .catch(error => {
        alert(`‚ùå Network error: ${error}`);
        confirmModal.hide();
    })
    .finally(() => {
        // Reset button
        this.innerHTML = 'Delete';
        this.disabled = false;
    });
});

// Click on selection item toggles checkbox
document.querySelectorAll('.selection-item').forEach(item => {
    item.addEventListener('click', function(e) {
        if (!e.target.classList.contains('data-checkbox')) {
            const checkbox = this.querySelector('.data-checkbox');
            checkbox.checked = !checkbox.checked;
            checkbox.dispatchEvent(new Event('change'));
        }
    });
});
</script>
{% endblock %}
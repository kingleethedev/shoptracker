{% extends "admin_base.html" %}

{% block title %}Edit Product - Caspian Shop{% endblock %}

{% block page_title %}Edit Product{% endblock %}

{% block admin_content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-pencil"></i> Edit Product: {{ product.name }}
                </h5>
            </div>
            <div class="card-body">
                <!-- Current Product Info -->
                <div class="row mb-4">
                    <div class="col-md-4 text-center">
                        <img src="{{ url_for('uploaded_file', filename=product.image_filename) if product.image_filename else url_for('static', filename='img/default-product.png') }}" 
                             class="img-fluid rounded border"
                             style="max-height: 200px;"
                             alt="{{ product.name }}"
                             onerror="this.src='{{ url_for('static', filename='img/default-product.png') }}'">
                    </div>
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted d-block">Current Selling Price</small>
                                <h4 class="text-primary">KES {{ "%.2f"|format(product.selling_price) }}</h4>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Current Stock</small>
                                <h4>
                                    <span class="badge {% if product.quantity > 20 %}bg-success{% elif product.quantity > 10 %}bg-info{% elif product.quantity > 5 %}bg-warning{% else %}bg-danger{% endif %} fs-6">
                                        {{ product.quantity }} units
                                    </span>
                                </h4>
                            </div>
                            <div class="col-12 mt-3">
                                <small class="text-muted d-block">Current Profit per Unit</small>
                                <h4 class="text-success">
                                    KES {{ "%.2f"|format(product.selling_price - product.buying_price) }}
                                    <small class="text-muted">
                                        ({{ "%.1f"|format(((product.selling_price - product.buying_price)/product.selling_price)*100) }}% margin)
                                    </small>
                                </h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Form -->
                <form method="POST" action="{{ url_for('admin_edit_product', product_id=product.id) }}" enctype="multipart/form-data">
                    <div class="row g-3">
                        <!-- Product Name -->
                        <div class="col-md-12">
                            <label for="name" class="form-label fw-bold">Product Name</label>
                            <input type="text" 
                                   class="form-control" 
                                   id="name" 
                                   name="name" 
                                   value="{{ product.name }}"
                                   required>
                        </div>

                        <!-- Image Upload -->
                        <div class="col-md-12">
                            <label for="image" class="form-label fw-bold">Update Product Image</label>
                            <input type="file" 
                                   class="form-control" 
                                   id="image" 
                                   name="image" 
                                   accept="image/*">
                            <div class="form-text">
                                Leave empty to keep current image. Max size: 5MB
                            </div>
                        </div>

                        <!-- Prices -->
                        <div class="col-md-6">
                            <label for="buying_price" class="form-label fw-bold">Buying Price (KES)</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input type="number" 
                                       step="0.01" 
                                       class="form-control" 
                                       id="buying_price" 
                                       name="buying_price" 
                                       value="{{ "%.2f"|format(product.buying_price) }}"
                                       required>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <label for="selling_price" class="form-label fw-bold">Selling Price (KES)</label>
                            <div class="input-group">
                                <span class="input-group-text">KES</span>
                                <input type="number" 
                                       step="0.01" 
                                       class="form-control" 
                                       id="selling_price" 
                                       name="selling_price" 
                                       value="{{ "%.2f"|format(product.selling_price) }}"
                                       required>
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="col-md-12">
                            <label for="quantity" class="form-label fw-bold">Stock Quantity</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="bi bi-box"></i>
                                </span>
                                <input type="number" 
                                       class="form-control" 
                                       id="quantity" 
                                       name="quantity" 
                                       value="{{ product.quantity }}" 
                                       min="0"
                                       required>
                                <button type="button" class="btn btn-outline-secondary" onclick="addStock(10)">
                                    +10
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="addStock(50)">
                                    +50
                                </button>
                            </div>
                        </div>

                        <!-- Profit Preview -->
                        <div class="col-md-12">
                            <div class="card border-info mt-3">
                                <div class="card-body">
                                    <h6 class="card-title text-info">
                                        <i class="bi bi-calculator"></i> Updated Profit Preview
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">New Profit per Unit</small>
                                            <h4 id="updatedProfit" class="text-success">
                                                KES {{ "%.2f"|format(product.selling_price - product.buying_price) }}
                                            </h4>
                                        </div>
                                        <div class="col-md-6">
                                            <small class="text-muted d-block">New Profit Margin</small>
                                            <h4 id="updatedMargin" class="text-primary">
                                                {{ "%.1f"|format(((product.selling_price - product.buying_price)/product.selling_price)*100) }}%
                                            </h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="d-flex justify-content-between">
                                <a href="{{ url_for('admin_products') }}" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </a>
                                <div>
                                    <button type="button" 
                                            class="btn btn-outline-danger me-2"
                                            onclick="confirmDelete()">
                                        <i class="bi bi-trash"></i> Delete Product
                                    </button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="bi bi-check-circle"></i> Update Product
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Update profit preview in real-time
function updateProfitPreview() {
    const buyingPrice = parseFloat(document.getElementById('buying_price').value) || 0;
    const sellingPrice = parseFloat(document.getElementById('selling_price').value) || 0;
    
    const profit = sellingPrice - buyingPrice;
    const margin = sellingPrice > 0 ? ((profit / sellingPrice) * 100).toFixed(1) : 0;
    
    document.getElementById('updatedProfit').textContent = `KES ${profit.toFixed(2)}`;
    document.getElementById('updatedMargin').textContent = `${margin}%`;
    
    // Color code
    const profitElement = document.getElementById('updatedProfit');
    if (profit > 0) {
        profitElement.className = 'text-success';
    } else if (profit < 0) {
        profitElement.className = 'text-danger';
    } else {
        profitElement.className = 'text-muted';
    }
}

// Add stock quickly
function addStock(amount) {
    const quantityInput = document.getElementById('quantity');
    const currentValue = parseInt(quantityInput.value) || 0;
    quantityInput.value = currentValue + amount;
}

// Confirm delete
function confirmDelete() {
    if (confirm('Are you sure you want to delete this product? This action cannot be undone.')) {
        window.location.href = "{{ url_for('admin_delete_product', product_id=product.id) }}";
    }
}

// Add event listeners
document.getElementById('buying_price').addEventListener('input', updateProfitPreview);
document.getElementById('selling_price').addEventListener('input', updateProfitPreview);

// Validate selling price
document.getElementById('selling_price').addEventListener('blur', function() {
    const buyingPrice = parseFloat(document.getElementById('buying_price').value) || 0;
    const sellingPrice = parseFloat(this.value) || 0;
    
    if (sellingPrice <= buyingPrice) {
        alert('Warning: Selling price should be higher than buying price for profit!');
    }
});
</script>
{% endblock %}